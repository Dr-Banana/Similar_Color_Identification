import numpy as np
import matplotlib.pyplot as plt

def rgb2lab(rgb):
    r, g, b = rgb[:, :, 0], rgb[:, :, 1], rgb[:, :, 2]
    x, y, z = (0.412453 * r + 0.357580 * g + 0.180423 * b,
               0.212671 * r + 0.715160 * g + 0.072169 * b,
               0.019334 * r + 0.119193 * g + 0.950227 * b)
    x /= 0.950456
    y /= 1.0
    z /= 1.088754
    fx = (x > 0.008856) * np.cbrt(x) + (x <= 0.008856) * (7.787 * x + 16 / 116)
    fy = (y > 0.008856) * np.cbrt(y) + (y <= 0.008856) * (7.787 * y + 16 / 116)
    fz = (z > 0.008856) * np.cbrt(z) + (z <= 0.008856) * (7.787 * z + 16 / 116)

    l = 116 * fy - 16
    a = 500 * (fx - fy)
    b = 200 * (fy - fz)
    return np.stack([l, a, b], axis=2)



def lab2rgb(lab):
    l, a, b = lab[0], lab[1], lab[2]
    fy = (l + 16) / 116
    fx = a / 500 + fy
    fz = fy - b / 200
    x = np.where(fx**3 > 0.008856, fx**3, (116*fx-16)/903.3)
    y = np.where(l > 903.3*0.008856, ((l+16)/116)**3, l/903.3)
    z = np.where(fz**3 > 0.008856, fz**3, (116*fz-16)/903.3)
    x *= 0.950456
    z *= 1.088754
    r = 3.240479*x - 1.537150*y - 0.498535*z
    g = -0.969256*x + 1.875992*y + 0.041556*z
    b = 0.055648*x - 0.204043*y + 1.057311*z
    return (r, g, b)

